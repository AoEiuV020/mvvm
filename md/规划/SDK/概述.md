# IM SDK 概述

## 简介

IM SDK 是独立的即时通讯核心模块，提供与 UI 无关的所有功能实现。各 UI 框架项目通过 SDK 接口调用核心功能。

---

## 使用规范

**依赖注入优先**
- ViewModel 通过构造函数接收 SDK 接口
- 禁止在 ViewModel 内部直接创建 SDK 实例
- 禁止使用全局单例或静态方法访问 SDK

**优点：**
- 便于单元测试 mock
- 解耦 ViewModel 与 SDK 具体实现

具体框架的依赖注入方案见对应框架文档。

---

## 模块划分

| 模块 | 接口 | 所属模块 | 说明 |
|------|------|----------|------|
| [认证模块](认证模块.md) | `IAuthService` | sdk-http | HTTP 登录、注册、Token 管理 |
| [同步模块](同步模块.md) | `ISyncService` | sdk-http | 数据同步（用户信息/好友/群组） |
| [连接模块](连接模块.md) | `IConnectionService` | sdk-tcp | TCP 长连接管理 |
| [用户模块](用户模块.md) | `IUserService` | sdk-http | 用户信息、资料更新 |
| [会话模块](会话模块.md) | `IConversationService` | sdk-db | 会话列表、创建/删除会话 |
| [消息模块](消息模块.md) | `IMessageService` | sdk-tcp | 发送/接收消息、消息历史 |
| [联系人模块](联系人模块.md) | `IContactService` | sdk-db | 好友管理、好友申请 |

---

## SDK 初始化

```dart
abstract class IMSDK {
  Future<void> init(SDKConfig config);
  
  IAuthService get authService;
  ISyncService get syncService;
  IConnectionService get connectionService;
  IUserService get userService;
  IConversationService get conversationService;
  IMessageService get messageService;
  IContactService get contactService;
  
  Future<void> destroy();
}

class SDKConfig {
  final String appId;
  final String serverUrl;
}
```

---

## 登录流程

### App 启动判断

```dart
if (authService.hasLoginToken) {
  // 有 loginToken → 跳转到启动页，执行自动登录流程
} else {
  // 无 loginToken → 跳转到登录页
}
```

### 手动登录流程

```dart
// 1. HTTP 登录（成功返回凭证，失败抛 AuthException）
await sdk.authService.login(countryCode, phone, password);

// 2. 数据同步（失败抛 SyncException）
await sdk.syncService.syncAll();

// 3. TCP 连接（失败抛 ConnectException）
await sdk.connectionService.connect();
```

### 自动登录流程

```dart
// 1. 使用 loginToken 刷新 accessToken
await sdk.authService.autoLogin();

// 2. 数据同步
await sdk.syncService.syncAll();

// 3. TCP 连接
await sdk.connectionService.connect();
```

---

## 内部状态管理

SDK 内部维护以下状态，UI 层无需关心：

| 状态 | 模块 | 说明 |
|------|------|------|
| loginToken | sdk-db | 长期有效，用于自动登录 |
| accessToken | sdk-http | 短期有效，用于 API 请求 |
| userId | sdk-http | 登录成功后保存 |
| 连接状态 | sdk-tcp | 长连接状态，支持自动重连 |

**约束：**
- Token 由 SDK 内部持久化存储
- UI 层不得直接访问 Token，通过接口判断状态
- 通过 `authService.hasLoginToken` 判断是否可自动登录
- 通过 `authService.isLoggedIn` 判断是否已登录

---

## 通用数据类型

```dart
class User {
  final String id;
  final String countryCode;
  final String phone;
  final String nickname;
  final String avatar;
  final UserStatus status;
}

enum UserStatus { online, offline, busy, away }
```
