# 认证模块

所属模块：`sdk-http`

## Token 体系

| Token | 有效期 | 用途 |
|-------|--------|------|
| `loginToken` | 长期（如 30 天） | 自动登录，刷新 accessToken |
| `accessToken` | 短期（如 2 小时） | API 请求、TCP 登录 |

Token 由 SDK 内部持久化存储（sdk-db），App 层无需管理。

## 接口定义

```dart
abstract class IAuthService {
  /// 是否有有效的 loginToken（可自动登录）
  bool get hasLoginToken;
  
  /// 是否有有效的 accessToken（已登录状态）
  bool get isLoggedIn;
  
  /// 当前用户 ID（已登录时返回）
  String? get userId;
  
  /// 手动登录
  /// - selectedUserId 为 null：首次登录，可能返回多用户
  /// - selectedUserId 非 null：选择用户后登录，直接返回成功
  /// - 失败：抛 AuthException
  Future<LoginResult> login(
    String countryCode,
    String phone,
    String password, {
    String? selectedUserId,
  });
  
  /// 注册，成功返回凭证，失败抛 AuthException
  Future<RegisterCredential> register(String countryCode, String phone, String password, String nickname);
  
  /// 自动登录（使用 loginToken 刷新 accessToken），失败抛 AuthException
  Future<void> autoLogin();
  
  /// 登出（清除所有 Token）
  Future<void> logout();
}
```

## App 启动判断逻辑

```dart
if (authService.hasLoginToken) {
  // 有 loginToken → 跳转到启动页/主页，执行自动登录
} else {
  // 无 loginToken → 跳转到登录页
}
```

---

## 数据类型

```dart
/// 登录结果（sealed class）
sealed class LoginResult {}

/// 登录成功
class LoginSuccess extends LoginResult {
  final LoginCredential credential;
  LoginSuccess(this.credential);
}

/// 需要选择用户
class LoginMultipleUsers extends LoginResult {
  final List<UserOption> users;
  LoginMultipleUsers(this.users);
}

/// 可选用户信息
class UserOption {
  final String userId;
  final String nickname;
  final String? avatar;
}

/// 登录成功凭证（SDK 内部已保存）
class LoginCredential {
  final String userId;
}

/// 注册成功凭证（SDK 内部已保存）
class RegisterCredential {
  final String userId;
}

/// 认证异常（失败时抛出）
class AuthException implements Exception {
  final AuthError error;
  AuthException(this.error);
}

enum AuthError {
  invalidCredentials,  // 手机号或密码错误
  userNotFound,        // 用户不存在
  userAlreadyExists,   // 用户已存在
  loginTokenExpired,   // loginToken 过期，需重新登录
  networkError,        // 网络错误
  serverError,         // 服务器错误
}
```

---

## 使用示例

**手动登录（单用户）：**
```dart
final result = await authService.login('+86', '13800138000', 'password');
switch (result) {
  case LoginSuccess(:final credential):
    // 登录成功，跳转到数据同步页
  case LoginMultipleUsers(:final users):
    // 显示用户选择 UI
}
```

**选择用户后继续登录：**
```dart
final result = await authService.login(
  '+86', '13800138000', 'password', 
  selectedUserId: selectedUser.userId,
);
// result 必定为 LoginSuccess
```

**自动登录：**
```dart
try {
  await authService.autoLogin();
  // 自动登录成功，跳转到数据同步页
} on AuthException catch (e) {
  if (e.error == AuthError.loginTokenExpired) {
    // Token 过期，跳转到登录页
  }
}
```

---

## 说明

- 登录成功后仅获取 token 和 userId
- 完整用户信息需通过 [同步模块](同步模块.md) 获取
- TCP 连接需通过 [连接模块](连接模块.md) 建立
