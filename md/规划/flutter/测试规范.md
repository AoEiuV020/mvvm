# Flutter 测试规范

## 目录结构

测试文件与源文件一一对应，保持相同的层级关系：

```
lib/src/
  login/
    login_validator.dart      # Model层
    login_viewmodel.dart      # ViewModel层
    login_page.dart           # View层

test/
  login/
    login_validator_test.dart # Model层测试
    login_viewmodel_test.dart # ViewModel层测试
    login_page_test.dart      # View层测试（Widget测试）
```

## ViewModel 单元测试

```dart
@GenerateMocks([IAuthService])
void main() {
  late MockIAuthService mockService;
  late ProviderContainer container;
  
  setUp(() {
    mockService = MockIAuthService();
    container = ProviderContainer(
      overrides: [authServiceProvider.overrideWithValue(mockService)],
    );
  });
  
  tearDown(() => container.dispose());
  
  // sealed class 返回类型需要 provideDummy
  setUpAll(() {
    provideDummy<LoginResult>(const LoginSuccess(LoginCredential(userId: 'dummy')));
  });
  
  group('登录ViewModel', () {
    test('登录成功返回true', () async {
      when(mockService.login(any, any, any))
          .thenAnswer((_) async => const LoginSuccess(LoginCredential(userId: 'user')));
      
      final vm = container.read(loginViewModelProvider.notifier);
      final result = await vm.login();
      
      expect(result, true);
      expect(container.read(loginViewModelProvider).isLoading, false);
    });
  });
}
```

## Widget 测试

```dart
@GenerateMocks([IAuthService])
void main() {
  late MockIAuthService mockService;
  
  setUp(() => mockService = MockIAuthService());
  
  setUpAll(() {
    provideDummy<LoginResult>(const LoginSuccess(LoginCredential(userId: 'dummy')));
  });
  
  group('登录页Widget测试', () {
    testWidgets('渲染登录表单元素', (tester) async {
      await tester.pumpWidget(
        ProviderScope(
          overrides: [imsdkProvider.overrideWithValue(_MockIMSDK(mockService))],
          child: MaterialApp(home: LoginPage()),
        ),
      );
      
      expect(find.text('手机号'), findsOneWidget);
    });
  });
}

/// Mock IMSDK 实现
class _MockIMSDK implements IMSDK {
  final IAuthService _authService;
  _MockIMSDK(this._authService);
  
  @override
  IAuthService get authService => _authService;
  // 其他 service getter 按需实现
}
```

## Mock 生成

使用 mockito，运行 `melos gen --no-select` 生成 mock 类和 riverpod 代码。
