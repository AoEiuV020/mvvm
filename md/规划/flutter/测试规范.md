# Flutter 测试规范

## 单元测试

### ViewModel 测试

```dart
// test/viewmodels/login_viewmodel_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:mockito/mockito.dart';
import 'package:mockito/annotations.dart';

@GenerateMocks([IAuthService])
import 'login_viewmodel_test.mocks.dart';

void main() {
  late MockIAuthService mockAuthService;
  late LoginViewModel viewModel;
  
  setUp(() {
    mockAuthService = MockIAuthService();
    viewModel = LoginViewModel(mockAuthService);
  });
  
  group('LoginViewModel', () {
    test('初始状态正确', () {
      expect(viewModel.username, '');
      expect(viewModel.password, '');
      expect(viewModel.isLoading, false);
      expect(viewModel.errorMessage, null);
      expect(viewModel.isLoginEnabled, false);
    });
    
    test('输入用户名和密码后 isLoginEnabled 为 true', () {
      viewModel.setUsername('user');
      viewModel.setPassword('password');
      
      expect(viewModel.isLoginEnabled, true);
    });
    
    test('登录成功返回 true', () async {
      when(mockAuthService.login('user', 'password'))
          .thenAnswer((_) async => LoginResult(success: true));
      
      viewModel.setUsername('user');
      viewModel.setPassword('password');
      
      final result = await viewModel.login();
      
      expect(result, true);
      expect(viewModel.errorMessage, null);
    });
    
    test('登录失败设置错误信息', () async {
      when(mockAuthService.login('user', 'wrong'))
          .thenAnswer((_) async => LoginResult(
            success: false, 
            error: AuthError.invalidCredentials,
          ));
      
      viewModel.setUsername('user');
      viewModel.setPassword('wrong');
      
      final result = await viewModel.login();
      
      expect(result, false);
      expect(viewModel.errorMessage, '用户名或密码错误');
    });
  });
}
```

## Widget 测试

```dart
// test/views/login_page_test.dart
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

void main() {
  testWidgets('登录页面显示正确', (tester) async {
    await tester.pumpWidget(
      ProviderScope(
        overrides: [
          loginViewModelProvider.overrideWith(
            (ref) => MockLoginViewModel(),
          ),
        ],
        child: MaterialApp(home: LoginPage()),
      ),
    );
    
    expect(find.byType(TextField), findsNWidgets(2));
    expect(find.text('登录'), findsOneWidget);
  });
}
```

## 测试依赖

```yaml
dev_dependencies:
  flutter_test:
    sdk: flutter
  mockito: ^5.4.0
  build_runner: ^2.4.0
```

## Mock 生成

```bash
dart run build_runner build
```
