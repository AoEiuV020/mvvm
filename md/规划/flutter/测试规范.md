# Flutter 测试规范

## ViewModel 单元测试

```dart
@GenerateMocks([IAuthService])
void main() {
  late MockIAuthService mockService;
  late ProviderContainer container;
  
  setUp(() {
    mockService = MockIAuthService();
    container = ProviderContainer(
      overrides: [authServiceProvider.overrideWithValue(mockService)],
    );
  });
  
  tearDown(() => container.dispose());
  
  // sealed class 返回类型需要 provideDummy
  setUpAll(() {
    provideDummy<LoginResult>(const LoginSuccess(LoginCredential(userId: 'dummy')));
  });
  
  test('xxx', () async {
    when(mockService.action()).thenAnswer((_) async => Result(success: true));
    
    final vm = container.read(xxxViewModelProvider.notifier);
    final result = await vm.doAction();
    
    expect(result, true);
    expect(container.read(xxxViewModelProvider).isLoading, false);
  });
}
```

## Widget 测试

```dart
@GenerateMocks([IAuthService])
void main() {
  late MockIAuthService mockService;
  
  setUp(() => mockService = MockIAuthService());
  
  setUpAll(() {
    provideDummy<LoginResult>(const LoginSuccess(LoginCredential(userId: 'dummy')));
  });
  
  testWidgets('xxx', (tester) async {
    await tester.pumpWidget(
      ProviderScope(
        overrides: [imsdkProvider.overrideWithValue(_MockIMSDK(mockService))],
        child: MaterialApp(home: XxxPage()),
      ),
    );
    
    expect(find.byType(XxxWidget), findsOneWidget);
  });
}

/// Mock IMSDK 实现
class _MockIMSDK implements IMSDK {
  final IAuthService _authService;
  _MockIMSDK(this._authService);
  
  @override
  IAuthService get authService => _authService;
  // 其他 service getter 按需实现
}
```

## Mock 生成

使用 mockito，运行 `melos gen --no-select` 生成 mock 类和 riverpod 代码。
