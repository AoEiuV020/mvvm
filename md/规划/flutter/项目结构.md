# Flutter 项目结构

基于[通用多模块结构](../通用/多模块结构.md)，本文定义 Flutter 的具体实现。

## Workspace 多模块结构

Flutter 项目使用下划线命名，使用 Melos 管理多包：

```
flutter_im/
├── pubspec.yaml
├── melos.yaml
├── packages/
│   ├── im_sdk_api/             # SDK 接口层
│   ├── im_sdk_tcp/             # TCP 长连接
│   ├── im_sdk_http/            # HTTP 请求
│   ├── im_sdk_db/              # 本地数据库
│   ├── im_sdk/                 # SDK 聚合模块
│   ├── im_ui_core/             # UI 核心层
│   ├── im_login/               # 登录功能模块
│   ├── im_chat/                # 聊天功能模块
│   ├── im_conversation/        # 会话功能模块
│   ├── im_emoji/               # Emoji 功能模块
│   ├── im_group/               # 群组功能模块
│   ├── im_enterprise/          # 企业功能模块
│   ├── im_sdkui/               # UI 组装层
│   └── im_uikit/               # 纯 UI 组件
└── apps/
    └── im_app/                 # 主应用
```

## 模块对应关系

| 通用模块 | Flutter 模块 |
|----------|--------------|
| sdk-api | `im_sdk_api` |
| sdk-tcp | `im_sdk_tcp` |
| sdk-http | `im_sdk_http` |
| sdk-db | `im_sdk_db` |
| sdk | `im_sdk` |
| ui-core | `im_ui_core` |
| login | `im_login` |
| chat | `im_chat` |
| conversation | `im_conversation` |
| emoji | `im_emoji` |
| group | `im_group` |
| enterprise | `im_enterprise` |
| sdkui | `im_sdkui` |
| uikit | `im_uikit` |
| app | `im_app` |

## 核心层（im_ui_core）

包含公共 SDK Providers 和嵌入式组件接口：

```dart
/// SDK Provider（需在 ProviderScope 中 override）
@Riverpod(keepAlive: true)
IMSDK imsdk(Ref ref) {
  throw UnimplementedError('imsdkProvider must be overridden');
}

/// AuthService Provider（派生自 SDK）
@Riverpod(keepAlive: true)
IAuthService authService(Ref ref) => ref.read(imsdkProvider).authService;
```

嵌入式组件接口（用于在其他页面内嵌入的功能）：

```dart
/// Emoji 功能接口
abstract interface class IEmojiProvider {
  /// 构建 emoji 选择面板
  Widget buildPanel({required void Function(String emoji) onSelected});
  
  /// 支持的 emoji 列表
  List<String> get emojiList;
}

/// 语音录制接口
abstract interface class IVoiceRecorderProvider {
  Widget buildRecorder({required void Function(VoiceData) onRecorded});
}
```

**注意：页面模块（login/chat/conversation）不需要接口，通过路由组装。**

## 页面模块实现

页面模块直接导出 Page Widget，由 sdkui 路由配置引用：

```dart
// im_login 导出
export 'src/login_page.dart';
export 'src/register_page.dart';

// im_chat 导出
export 'src/chat_page.dart';
```

## 组装层（im_sdkui）

组装层负责：
1. **统一路由配置**：定义所有功能模块的路由
2. **重新导出**：导出所有功能模块的公共 API

```dart
/// IM SDK UI 组装层
library;

// 路由配置
export 'src/router/app_router.dart';

// 重新导出所有模块
export 'package:im_ui_core/im_ui_core.dart';
export 'package:im_login/im_login.dart';
export 'package:im_chat/im_chat.dart';
export 'package:im_emoji/im_emoji.dart';
```

路由配置（组装模块间导航）：

```dart
// im_sdkui/lib/src/router/app_router.dart
GoRouter createAppRouter({required void Function() onLoginSuccess}) {
  return GoRouter(
    initialLocation: '/login',
    routes: [
      GoRoute(
        path: '/login',
        builder: (context, state) => LoginPage(
          onLoginSuccess: onLoginSuccess,
          onRegisterTap: () => GoRouter.of(context).go('/register'),
          onForgotPasswordTap: () { /* TODO */ },
        ),
      ),
      GoRoute(path: '/register', builder: (_, __) => const RegisterPage()),
      GoRoute(path: '/conversations', builder: (_, __) => const ConversationListPage()),
    ],
  );
}
```

## 文件命名规范

| 类型 | 命名格式 | 示例 |
|------|----------|------|
| 嵌入式组件接口 | `xxx_provider.dart` | `emoji_provider.dart` |
| 嵌入式组件实现 | `xxx_provider_impl.dart` | `emoji_provider_impl.dart` |
| ViewModel | `xxx_viewmodel.dart` | `login_viewmodel.dart` |
| State | `xxx_state.dart` | `login_state.dart` |
| View/Page | `xxx_page.dart` | `login_page.dart` |
| Widget | `xxx_widget.dart` | `message_bubble_widget.dart` |
| Validator | `xxx_validator.dart` | `login_validator.dart` |

## 模块内目录结构

### im_ui_core（核心层）

```
im_ui_core/lib/
├── src/
│   ├── interfaces/
│   │   ├── emoji_provider.dart      # 嵌入式组件接口
│   │   └── voice_recorder_provider.dart
│   └── providers/
│       └── sdk_providers.dart       # imsdkProvider, authServiceProvider 等
└── im_ui_core.dart
```

### im_login（页面模块）

```
im_login/lib/
├── src/
│   ├── login_page.dart
│   ├── register_page.dart
│   ├── login_viewmodel.dart
│   ├── login_state.dart
│   └── login_validator.dart
└── im_login.dart
```

### im_emoji（嵌入式组件模块）

```
im_emoji/lib/
├── src/
│   ├── emoji_provider_impl.dart     # 实现 IEmojiProvider
│   └── emoji_panel.dart
└── im_emoji.dart
```

### im_sdkui（组装层）

```
im_sdkui/lib/
├── src/
│   └── router/
│       └── app_router.dart          # 统一路由配置
└── im_sdkui.dart                    # 导出路由和所有功能模块
```

### im_app（主应用）

```
im_app/lib/
├── main.dart                        # 入口，使用 sdkui 的路由
└── theme/
    └── app_theme.dart
```
