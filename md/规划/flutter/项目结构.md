# Flutter 项目结构

基于[通用多模块结构](../通用/多模块结构.md)，本文定义 Flutter 的具体实现。

## Workspace 多模块结构

Flutter 项目使用下划线命名，使用 Melos 管理多包：

```
flutter_im/
├── pubspec.yaml
├── melos.yaml
├── packages/
│   ├── im_sdk_api/             # SDK 接口层
│   ├── im_sdk_tcp/             # TCP 长连接
│   ├── im_sdk_http/            # HTTP 请求
│   ├── im_sdk_db/              # 本地数据库
│   ├── im_sdk/                 # SDK 聚合模块
│   ├── im_ui_core/             # UI 核心层
│   ├── im_login/               # 登录功能模块
│   ├── im_chat/                # 聊天功能模块
│   ├── im_conversation/        # 会话功能模块
│   ├── im_emoji/               # Emoji 功能模块
│   ├── im_group/               # 群组功能模块
│   ├── im_enterprise/          # 企业功能模块
│   ├── im_sdkui/               # UI 组装层
│   └── im_uikit/               # 纯 UI 组件
└── apps/
    └── im_app/                 # 主应用
```

## 模块对应关系

| 通用模块 | Flutter 模块 |
|----------|--------------|
| sdk-api | `im_sdk_api` |
| sdk-tcp | `im_sdk_tcp` |
| sdk-http | `im_sdk_http` |
| sdk-db | `im_sdk_db` |
| sdk | `im_sdk` |
| ui-core | `im_ui_core` |
| login | `im_login` |
| chat | `im_chat` |
| conversation | `im_conversation` |
| emoji | `im_emoji` |
| group | `im_group` |
| enterprise | `im_enterprise` |
| sdkui | `im_sdkui` |
| uikit | `im_uikit` |
| app | `im_app` |

## 核心层（im_ui_core）

包含：
- **公共 SDK Providers**：`imsdkProvider`（需 override）、派生 Service Providers
- **嵌入式组件接口**：横切多个页面的功能（如企业模块、Emoji 模块）

**嵌入式组件 Provider 模式：**
- 接口方法返回非空 Widget
- Provider 默认返回 null
- 有对应模块时 override Provider
- 使用方检查 null 决定是否显示

## 页面模块

直接导出 Page Widget，由 sdkui 路由配置引用。无需定义接口。

## 组装层（im_sdkui）

组装层负责：
1. **统一路由配置**：定义所有页面模块的路由，处理模块间导航
2. **模块聚合**：依赖所有嵌入式组件模块，提供 `defaultOverrides` 供 App 使用
3. **重新导出**：导出 im_ui_core 和所有功能模块的公共 API

### 模块聚合 API

```dart
/// 默认模块 overrides 列表（包含所有已安装模块的默认实现）
List<Override> get defaultOverrides;

/// 创建模块 overrides 列表（允许自定义替换部分模块实现）
List<Override> createOverrides({
  IEmojiProvider? emoji,
  IEnterpriseProvider? enterprise,
});
```

### App 层使用

```dart
ProviderScope(
  overrides: defaultOverrides,
  child: MyApp(),
)
```

或自定义部分实现：

```dart
ProviderScope(
  overrides: createOverrides(
    emoji: MyCustomEmojiProvider(),
  ),
  child: MyApp(),
)
```

## 文件命名规范

| 类型 | 命名格式 | 示例 |
|------|----------|------|
| 嵌入式组件接口 | `xxx_provider.dart` | `enterprise_provider.dart` |
| 嵌入式组件实现 | `xxx_provider_impl.dart` | `enterprise_provider_impl.dart` |
| ViewModel | `xxx_viewmodel.dart` | `login_viewmodel.dart` |
| State | `xxx_state.dart` | `login_state.dart` |
| View/Page | `xxx_page.dart` | `login_page.dart` |
| Widget | `xxx_widget.dart` | `message_bubble_widget.dart` |
| Validator | `xxx_validator.dart` | `login_validator.dart` |

## 模块内目录结构

### im_ui_core（核心层）

```
im_ui_core/lib/
├── src/
│   ├── interfaces/          # 嵌入式组件接口
│   └── providers/           # 公共 Providers
└── im_ui_core.dart
```

### 页面模块（im_login）

```
im_login/lib/
├── src/
│   ├── login_page.dart
│   ├── login_viewmodel.dart
│   └── ...
└── im_login.dart
```

### 嵌入式组件模块（im_enterprise）

```
im_enterprise/lib/
├── src/
│   ├── enterprise_provider_impl.dart  # 实现 IEnterpriseProvider
│   └── ...
└── im_enterprise.dart
```

### im_sdkui（组装层）

```
im_sdkui/lib/
├── src/
│   ├── router/app_router.dart
│   └── module_overrides.dart
└── im_sdkui.dart
```

### im_app（主应用）

```
im_app/lib/
├── main.dart
└── ...
```
