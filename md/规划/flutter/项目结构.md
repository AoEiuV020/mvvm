# Flutter 项目结构

基于[通用多模块结构](../通用/多模块结构.md)，本文定义 Flutter 的具体实现。

## Workspace 多模块结构

Flutter 项目使用下划线命名，使用 Melos 管理多包：

```
flutter_im/
├── pubspec.yaml
├── melos.yaml
├── packages/
│   ├── im_sdk_api/             # SDK 接口层
│   ├── im_sdk_tcp/             # TCP 长连接
│   ├── im_sdk_http/            # HTTP 请求
│   ├── im_sdk_db/              # 本地数据库
│   ├── im_sdk/                 # SDK 聚合模块
│   ├── im_ui_core/             # UI 核心层
│   ├── im_login/               # 登录功能模块
│   ├── im_chat/                # 聊天功能模块
│   ├── im_conversation/        # 会话功能模块
│   ├── im_emoji/               # Emoji 功能模块
│   ├── im_group/               # 群组功能模块
│   ├── im_enterprise/          # 企业功能模块
│   ├── im_sdkui/               # UI 组装层
│   └── im_uikit/               # 纯 UI 组件
└── apps/
    └── im_app/                 # 主应用
```

## 模块对应关系

| 通用模块 | Flutter 模块 |
|----------|--------------|
| sdk-api | `im_sdk_api` |
| sdk-tcp | `im_sdk_tcp` |
| sdk-http | `im_sdk_http` |
| sdk-db | `im_sdk_db` |
| sdk | `im_sdk` |
| ui-core | `im_ui_core` |
| login | `im_login` |
| chat | `im_chat` |
| conversation | `im_conversation` |
| emoji | `im_emoji` |
| group | `im_group` |
| enterprise | `im_enterprise` |
| sdkui | `im_sdkui` |
| uikit | `im_uikit` |
| app | `im_app` |

## 核心层（im_ui_core）

定义功能模块接口和公共 SDK Providers：

```dart
/// 登录功能接口
abstract interface class ILoginProvider {
  /// 构建登录页面
  Widget buildLoginPage();
  
  /// 构建注册页面
  Widget buildRegisterPage();
}

/// Emoji 功能接口
abstract interface class IEmojiProvider {
  /// 构建 emoji 选择面板
  Widget buildPanel({required void Function(String emoji) onSelected});
  
  /// 支持的 emoji 列表
  List<String> get emojiList;
}
```

公共 SDK Providers：

```dart
/// SDK Provider（需在 ProviderScope 中 override）
@Riverpod(keepAlive: true)
IMSDK imsdk(Ref ref) {
  throw UnimplementedError('imsdkProvider must be overridden');
}

/// AuthService Provider（派生自 SDK）
@Riverpod(keepAlive: true)
IAuthService authService(Ref ref) => ref.read(imsdkProvider).authService;
```

## 功能模块实现

以 im_login 为例：

```dart
class LoginProviderImpl implements ILoginProvider {
  final VoidCallback onLoginSuccess;
  final VoidCallback onRegisterTap;
  final VoidCallback onForgotPasswordTap;

  LoginProviderImpl({
    required this.onLoginSuccess,
    required this.onRegisterTap,
    required this.onForgotPasswordTap,
  });

  @override
  Widget buildLoginPage() {
    return LoginPage(
      onLoginSuccess: onLoginSuccess,
      onRegisterTap: onRegisterTap,
      onForgotPasswordTap: onForgotPasswordTap,
    );
  }

  @override
  Widget buildRegisterPage() => const RegisterPage();
}
```

## 组装层（im_sdkui）

重新导出所有功能模块的公共 API：

```dart
/// IM SDK UI 组装层
library;

export 'package:im_ui_core/im_ui_core.dart';
export 'package:im_login/im_login.dart';
export 'package:im_chat/im_chat.dart';
export 'package:im_emoji/im_emoji.dart';
```

## 文件命名规范

| 类型 | 命名格式 | 示例 |
|------|----------|------|
| 接口定义 | `xxx_provider.dart` | `emoji_provider.dart` |
| 接口实现 | `xxx_provider_impl.dart` | `emoji_provider_impl.dart` |
| ViewModel | `xxx_viewmodel.dart` | `login_viewmodel.dart` |
| State | `xxx_state.dart` | `login_state.dart` |
| View/Page | `xxx_page.dart` | `login_page.dart` |
| Widget | `xxx_widget.dart` | `message_bubble_widget.dart` |
| Validator | `xxx_validator.dart` | `login_validator.dart` |

## 模块内目录结构

### im_ui_core（核心层）

```
im_ui_core/lib/
├── src/
│   ├── interfaces/
│   │   ├── login_provider.dart
│   │   ├── chat_provider.dart
│   │   └── emoji_provider.dart
│   └── providers/
│       └── sdk_providers.dart       # imsdkProvider, authServiceProvider 等
└── im_ui_core.dart
```

### im_login（功能模块）

```
im_login/lib/
├── src/
│   ├── login_provider_impl.dart
│   ├── login_page.dart
│   ├── login_viewmodel.dart
│   ├── login_state.dart
│   └── login_validator.dart
└── im_login.dart
```

### im_sdkui（组装层）

```
im_sdkui/lib/
└── im_sdkui.dart                    # 重新导出功能模块
```

### im_app（主应用）

```
im_app/lib/
├── main.dart
├── router/
│   └── app_router.dart
└── theme/
    └── app_theme.dart
```
