# 跨页面状态共享

基于[通用跨页面状态共享](../通用/跨页面状态共享.md)原则，Flutter 使用 Family Provider 实现。

## 场景

多个页面依赖同一份数据，且数据需要实时同步：

- 群聊页、群设置页、群管理页共享同一份 GroupInfo
- SDK 实时推送更新（禁言状态、权限变更等）
- 各页面实时响应

## 方案：Family Provider

使用 `@riverpod` 的 Family 特性，相同参数返回同一 Provider 实例。

### ViewModel 定义

```dart
@riverpod
class GroupInfoViewModel extends _$GroupInfoViewModel {
  @override
  GroupInfoState build(String groupId) {
    // 监听 SDK 实时更新
    final subscription = ref.read(groupServiceProvider).watchGroup(groupId).listen((info) {
      state = state.copyWith(groupInfo: info);
    });
    ref.onDispose(() => subscription.cancel());
    
    // 初始加载
    _loadGroupInfo();
    
    return GroupInfoState(groupId: groupId);
  }
  
  Future<void> _loadGroupInfo() async {
    final info = await ref.read(groupServiceProvider).getGroupInfo(groupId);
    state = state.copyWith(groupInfo: info);
  }
}
```

### 页面使用

```dart
// 群聊页
class GroupChatPage extends ConsumerWidget {
  final String groupId;
  
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final groupState = ref.watch(groupInfoViewModelProvider(groupId));
    // 使用 groupState.groupInfo
  }
}

// 群设置页
class GroupSettingsPage extends ConsumerWidget {
  final String groupId;
  
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final groupState = ref.watch(groupInfoViewModelProvider(groupId));
    // 使用 groupState.groupInfo，与群聊页共享同一实例
  }
}
```

## 工作原理

1. 多个页面调用 `ref.watch(groupInfoViewModelProvider(groupId))`
2. 相同 `groupId` → Riverpod 返回同一 Provider 实例
3. Provider 内部监听 SDK Stream
4. SDK 推送更新 → `state = state.copyWith(...)` → 所有页面自动刷新

## 生命周期

### 销毁时机（重点）

Provider 在以下情况下销毁：

1. **所有 listener 都停止监听** - 没有任何页面 `ref.watch` 该 Provider
2. **具体触发场景：**
   - 所有使用该 groupId 的页面都 pop 离开
   - 页面切换到不再 watch 该 Provider 的状态
   - ProviderScope 被销毁（如整个路由栈被替换）

### 不会销毁的情况

- 页面被遮挡但仍在路由栈中（如 push 新页面）
- 多个页面同时 watch 同一 Provider，只要还有一个在监听

### 销毁时的行为

- 触发 `ref.onDispose()` 回调
- 取消 SDK Stream 订阅
- 下次访问时重新创建 Provider、重新加载数据

## keepAlive 保持

如需保持状态不被销毁：

```dart
@Riverpod(keepAlive: true)
class GroupInfoViewModel extends _$GroupInfoViewModel {
  // ...
}
```

适用场景：频繁切换的页面、需要后台持续监听的数据。
