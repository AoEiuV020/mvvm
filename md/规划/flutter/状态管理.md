# Flutter 状态管理

## Provider 类型选择

| 场景 | Provider 类型 |
|------|---------------|
| SDK 服务（单例） | `Provider` |
| ViewModel | `ChangeNotifierProvider` |
| 带参数的 ViewModel | `ChangeNotifierProvider.family` |
| 异步数据 | `FutureProvider` / `StreamProvider` |

## ViewModel 实现模式

```dart
class XxxViewModel extends ChangeNotifier implements IXxxViewModel {
  final IXxxService _service;
  
  XxxViewModel(this._service);
  
  // 私有状态
  String _state = '';
  bool _isLoading = false;
  String? _errorMessage;
  
  // getter 暴露状态
  @override
  String get state => _state;
  
  // setter 更新状态并通知
  @override
  void setState(String value) {
    _state = value;
    notifyListeners();
  }
  
  // 异步操作
  @override
  Future<bool> doAction() async {
    _isLoading = true;
    notifyListeners();
    
    try {
      final result = await _service.action();
      return result.success;
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }
}
```

## 状态更新原则

1. 每次状态变更后调用 `notifyListeners()`
2. 批量更新时只调用一次
3. 异步操作前后都要更新 loading 状态
3. 异步操作前后都要更新 loading 状态
