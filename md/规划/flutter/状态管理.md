# Flutter 状态管理

## Riverpod 使用规范

### Provider 类型选择

| 场景 | Provider 类型 |
|------|---------------|
| SDK 服务（单例） | `Provider` |
| ViewModel（需要状态通知） | `ChangeNotifierProvider` |
| 带参数的 ViewModel | `ChangeNotifierProvider.family` |
| 异步数据 | `FutureProvider` / `StreamProvider` |

### ViewModel 实现

```dart
class LoginViewModel extends ChangeNotifier implements ILoginViewModel {
  final IAuthService _authService;
  
  LoginViewModel(this._authService);
  
  String _username = '';
  String _password = '';
  bool _isPasswordVisible = false;
  bool _isLoading = false;
  String? _errorMessage;
  
  @override
  String get username => _username;
  
  @override
  String get password => _password;
  
  @override
  bool get isPasswordVisible => _isPasswordVisible;
  
  @override
  bool get isLoading => _isLoading;
  
  @override
  String? get errorMessage => _errorMessage;
  
  @override
  bool get isLoginEnabled => _username.isNotEmpty && _password.isNotEmpty && !_isLoading;
  
  @override
  void setUsername(String value) {
    _username = value;
    _errorMessage = null;
    notifyListeners();
  }
  
  @override
  void setPassword(String value) {
    _password = value;
    _errorMessage = null;
    notifyListeners();
  }
  
  @override
  void togglePasswordVisibility() {
    _isPasswordVisible = !_isPasswordVisible;
    notifyListeners();
  }
  
  @override
  void clearError() {
    _errorMessage = null;
    notifyListeners();
  }
  
  @override
  Future<bool> login() async {
    _isLoading = true;
    _errorMessage = null;
    notifyListeners();
    
    try {
      final result = await _authService.login(_username, _password);
      
      if (result.success) {
        return true;
      } else {
        _errorMessage = _mapError(result.error);
        return false;
      }
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }
  
  String _mapError(AuthError? error) {
    switch (error) {
      case AuthError.invalidCredentials:
        return '用户名或密码错误';
      case AuthError.userNotFound:
        return '用户不存在';
      case AuthError.networkError:
        return '网络连接失败';
      case AuthError.serverError:
        return '服务器错误';
      default:
        return '未知错误';
    }
  }
}
```

### 状态更新原则

1. 每次状态变更后调用 `notifyListeners()`
2. 批量更新时只调用一次 `notifyListeners()`
3. 异步操作前后都要更新 loading 状态
