# Flutter 项目管理

## Workspace + Melos

项目使用 Flutter/Dart workspace + Melos 管理多包结构。

- 根 `pubspec.yaml` 定义 workspace 成员和 melos 脚本
- 统一依赖锁定（单一 `pubspec.lock`）
- 包结构详见 [项目结构](项目结构.md)

## Workspace 依赖

包之间使用版本约束依赖，workspace 内自动解析到本地版本：

```yaml
dependencies:
  im_sdk_api: ^1.0.0  # workspace 内解析到本地，发布后解析到 pub.dev
```

**禁止使用 path 依赖。**

## Melos 命令

**只允许使用以下 melos 命令，禁止直接使用 flutter/dart 命令：**

| 命令 | 说明 |
|------|------|
| `melos bs` | Bootstrap（内置），安装依赖 |
| `melos outdated --no-select` | 检查过期依赖 |
| `melos format --no-select` | 格式化代码 |
| `melos fix --no-select` | 应用 dart fix |
| `melos test --no-select` | 运行测试 |
| `melos analyze --no-select` | 代码分析 |
| `melos gen --no-select` | 运行 build_runner 生成代码 |
| `melos exec` | 在指定包执行命令（内置） |

**注意：** 非内置脚本运行时加 `--no-select` 自动执行所有匹配的包，不需要手动选择。

## 在指定包执行命令

```bash
# 在 im_app 包构建 macOS
melos exec --scope=im_app -- flutter build macos --debug

# 在所有包执行命令
melos exec -- dart pub upgrade
```

## 新增包

使用脚本创建新模块：

```bash
# 创建纯 Dart 包
script/package_create.sh im_new_module

# 创建 Flutter 包（包含 Flutter SDK 依赖）
script/package_create.sh im_new_module flutter
```

脚本自动完成：
1. 在 `packages/` 下创建包目录和 `pubspec.yaml`（包含 `resolution: workspace`）
2. 更新根 `pubspec.yaml` 的 `workspace` 列表

创建后运行 `melos bs` 安装依赖。

## 包间依赖版本

- 使用 caret 语法：`^1.0.0`
- 版本号需匹配，否则解析失败
- 发布时使用 pub.dev 版本
